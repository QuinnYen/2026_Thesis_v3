"""
Aspect Mask æ©Ÿåˆ¶åˆ†æèˆ‡å„ªåŒ–æ–¹æ¡ˆ

ç›®çš„ï¼šæ·±å…¥ç†è§£ç•¶å‰aspect maskå¦‚ä½•é‹ä½œï¼Œä»¥åŠå¦‚ä½•å„ªåŒ–ä»¥æå‡æ¨¡å‹æ€§èƒ½
"""

import torch
import torch.nn.functional as F
import sys
from pathlib import Path

# æ·»åŠ å°ˆæ¡ˆè·¯å¾‘
BASE_DIR = Path(__file__).parent
sys.path.insert(0, str(BASE_DIR / "src"))
sys.path.insert(0, str(BASE_DIR / "src" / "models"))

from models.components import AttentionLayer


def print_section(title):
    """æ‰“å°åˆ†éš”ç·š"""
    print("\n" + "="*80)
    print(f"{title}")
    print("="*80)


# ============================================================================
# ç¬¬ä¸€éƒ¨åˆ†ï¼šç•¶å‰ Aspect Mask æ©Ÿåˆ¶åˆ†æ
# ============================================================================

print_section("1. ç•¶å‰ Aspect Mask æ©Ÿåˆ¶é‹ä½œåŸç†")

print("""
ç•¶å‰æ©Ÿåˆ¶ï¼šHard Attention Maskingï¼ˆç¡¬æ³¨æ„åŠ›é®ç½©ï¼‰

ã€å·¥ä½œæµç¨‹ã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ1: æ•¸æ“šæº–å‚™ï¼ˆcleaned_data_loader.py:94-121ï¼‰             â”‚
â”‚  - è¼¸å…¥: å¥å­ + aspect term + å­—ç¬¦ä½ç½® [from_pos, to_pos)    â”‚
â”‚  - è¼¸å‡º: aspect_mask (å¸ƒæ—å‘é‡)                              â”‚
â”‚                                                              â”‚
â”‚  ä¾‹å¦‚ï¼š                                                       â”‚
â”‚    å¥å­: "The food is great but service is bad"             â”‚
â”‚    Aspect: "food"                                            â”‚
â”‚    Tokens:  [The, food, is, great, but, service, is, bad]   â”‚
â”‚    Mask:    [  Â·,   â–ˆ,  Â·,    Â·,   Â·,      Â·,  Â·,   Â·]     â”‚
â”‚             (åªæœ‰aspectè©ç‚ºTrueï¼Œå…¶ä»–ç‚ºFalse)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ2: BiLSTMç·¨ç¢¼ï¼ˆbaseline.py:126ï¼‰                         â”‚
â”‚  - è¼¸å…¥: è©åµŒå…¥ (batch_size, seq_len, embed_dim)            â”‚
â”‚  - è¼¸å‡º: LSTMéš±è—ç‹€æ…‹ (batch_size, seq_len, hidden_size*2)  â”‚
â”‚  - ä½œç”¨: æ•æ‰é›™å‘ä¸Šä¸‹æ–‡ä¿¡æ¯                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ3: Attentionè¨ˆç®—ï¼ˆcomponents.py:137-171ï¼‰                â”‚
â”‚                                                              â”‚
â”‚  3.1 è¨ˆç®—åŸå§‹attention scores:                               â”‚
â”‚      score_i = v^T * tanh(W * h_i + b)                      â”‚
â”‚      â†’ æ‰€æœ‰tokenéƒ½æœ‰åˆ†æ•¸                                      â”‚
â”‚                                                              â”‚
â”‚  3.2 æ‡‰ç”¨aspect maskï¼ˆç¡¬é®ç½©ï¼‰:                              â”‚
â”‚      score_i = -1e9  if mask_i == False                     â”‚
â”‚      score_i = score_i  if mask_i == True                   â”‚
â”‚                                                              â”‚
â”‚  3.3 Softmaxæ­¸ä¸€åŒ–:                                          â”‚
â”‚      attention_weights = softmax(scores)                     â”‚
â”‚      â†’ éaspect tokençš„æ¬Šé‡ â‰ˆ 0                              â”‚
â”‚      â†’ aspect tokençš„æ¬Šé‡ç¸½å’Œ = 1                            â”‚
â”‚                                                              â”‚
â”‚  3.4 åŠ æ¬Šæ±‚å’Œ:                                               â”‚
â”‚      context = Î£(attention_weights_i * h_i)                 â”‚
â”‚      â†’ å¹¾ä¹åªä½¿ç”¨aspect tokençš„è¡¨ç¤º                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")


# ============================================================================
# ç¬¬äºŒéƒ¨åˆ†ï¼šç•¶å‰æ©Ÿåˆ¶çš„å„ªç¼ºé»
# ============================================================================

print_section("2. ç•¶å‰æ©Ÿåˆ¶çš„å„ªç¼ºé»åˆ†æ")

print("""
âœ… å„ªé»ï¼š

1. ã€æ˜ç¢ºçš„ç›®æ¨™èšç„¦ã€‘
   - å¼·åˆ¶æ¨¡å‹åªé—œæ³¨aspectè©æœ¬èº«
   - é¿å…ç„¡é—œè©å¹²æ“¾
   - ç¬¦åˆaspect-based sentiment analysisçš„ç›´è¦º

2. ã€è¨ˆç®—é«˜æ•ˆã€‘
   - ç¡¬é®ç½©å¯¦ç¾ç°¡å–®
   - ä¸éœ€è¦é¡å¤–çš„å¯å­¸ç¿’åƒæ•¸
   - å‰å‘å‚³æ’­å¿«é€Ÿ

3. ã€å¯è§£é‡‹æ€§å¼·ã€‘
   - Attentionæ¬Šé‡æ¸…æ™°ï¼šaspectè©æ¬Šé‡é«˜ï¼Œå…¶ä»–ç‚º0
   - ä¾¿æ–¼è¦–è¦ºåŒ–å’Œdebug

4. ã€æ•¸å€¼ç©©å®šã€‘ï¼ˆå·²ä¿®å¾©ï¼‰
   - ä½¿ç”¨-1e9æ›¿ä»£-infé¿å…NaN
   - æœ‰fallbackæ©Ÿåˆ¶è™•ç†ç•°å¸¸æƒ…æ³

âŒ ç¼ºé»å’Œå±€é™æ€§ï¼š

1. ã€å¿½ç•¥ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘â˜…â˜…â˜… æœ€åš´é‡
   å•é¡Œï¼šåªçœ‹aspectè©ï¼Œä¸Ÿå¤±å‘¨åœçš„opinionè©

   ä¾‹å­ï¼š
   å¥å­: "The food is great but service is terrible"
   Aspect: "food"

   ç•¶å‰: åªé—œæ³¨ "food"
   å•é¡Œ: "great" é€™å€‹opinionè©æ²’è¢«åˆ©ç”¨ï¼

   ç†æƒ³: æ‡‰è©²åŒæ™‚é—œæ³¨ "food" + "great" + ä¸Šä¸‹æ–‡

2. ã€Multi-word aspectè™•ç†ä¸ç†æƒ³ã€‘
   å•é¡Œï¼šå¤šè©aspect (å¦‚ "battery life") è¢«åŒç­‰å°å¾…

   ç•¶å‰: ["battery", "life"] å…©å€‹tokenæ¬Šé‡ç›¸åŒ
   æ”¹é€²: "life" å¯èƒ½æ‡‰è©²æœ‰æ›´é«˜æ¬Šé‡ï¼ˆæ ¸å¿ƒè©ï¼‰

3. ã€ç„¡æ³•è™•ç†éš±å¼aspectã€‘
   å•é¡Œï¼šaspectè©ä¸åœ¨å¥å­ä¸­æ™‚ç„¡æ³•å·¥ä½œ

   ä¾‹å­: "This place is overpriced"
   çœŸå¯¦aspect: price (éš±å¼)
   ç•¶å‰: ç„¡æ³•è™•ç†ï¼Œå› ç‚ºæ²’æœ‰"price"é€™å€‹è©

4. ã€ç¡¬ç´„æŸå¤ªå¼·ã€‘
   å•é¡Œï¼šå®Œå…¨é˜»æ–·éaspectè©çš„ä¿¡æ¯æµ

   æ”¹é€²æ–¹å‘: è»Ÿé®ç½© (soft mask) å…è¨±å°‘é‡ä¸Šä¸‹æ–‡ä¿¡æ¯

5. ã€é•·è·é›¢ä¾è³´å›°é›£ã€‘
   ä¾‹å­: "The food, despite being cold, was still tasty"
   Aspect: "food"

   ç•¶å‰: åªçœ‹"food"ï¼Œ"cold"å’Œ"tasty"éƒ½æ²’ç”¨åˆ°
   å•é¡Œ: æƒ…æ„Ÿä¿®é£¾è©é›¢aspectè¼ƒé æ™‚ä¿¡æ¯ä¸Ÿå¤±
""")


# ============================================================================
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå„ªåŒ–æ–¹æ¡ˆ
# ============================================================================

print_section("3. å„ªåŒ–æ–¹æ¡ˆï¼šå¾ç¡¬é®ç½©åˆ°è»Ÿé®ç½© + ä¸Šä¸‹æ–‡æ„ŸçŸ¥")

print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆAï¼šSoft Maskingï¼ˆè»Ÿé®ç½©ï¼‰                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ¸å¿ƒæ€æƒ³ï¼šä¸æ˜¯å®Œå…¨é®è”½ï¼Œè€Œæ˜¯é™ä½éaspectè©çš„æ¬Šé‡              â”‚
â”‚                                                              â”‚
â”‚ å¯¦ç¾ï¼š                                                        â”‚
â”‚   åŸå§‹: score_i = -1e9 if not aspect                        â”‚
â”‚   æ”¹é€²: score_i = score_i - penalty if not aspect           â”‚
â”‚         penalty = lambda * distance_to_aspect                â”‚
â”‚                                                              â”‚
â”‚ æ•ˆæœï¼š                                                        â”‚
â”‚   - aspectè©ä¾ç„¶æœ‰æœ€é«˜æ¬Šé‡ï¼ˆ90%+ï¼‰                           â”‚
â”‚   - è¿‘é„°è©ç²å¾—å°‘é‡æ¬Šé‡ï¼ˆ5-10%ï¼‰                              â”‚
â”‚   - é è™•è©æ¬Šé‡æ¥µä½ï¼ˆ<1%ï¼‰                                    â”‚
â”‚                                                              â”‚
â”‚ å„ªé»ï¼š                                                        â”‚
â”‚   âœ“ ä¿ç•™aspectç‚ºä¸­å¿ƒ                                         â”‚
â”‚   âœ“ å…è¨±opinionè©è²¢ç»                                        â”‚
â”‚   âœ“ è·é›¢è¡°æ¸›ç¬¦åˆèªè¨€å­¸ç›´è¦º                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆBï¼šContextual Windowï¼ˆä¸Šä¸‹æ–‡çª—å£ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ¸å¿ƒæ€æƒ³ï¼šæ“´å±•maskç¯„åœåˆ°aspectçš„é„°è¿‘è©                        â”‚
â”‚                                                              â”‚
â”‚ å¯¦ç¾ï¼š                                                        â”‚
â”‚   window_size = 3  # å·¦å³å„3å€‹è©                            â”‚
â”‚   extended_mask[i] = True if |i - aspect_pos| <= window     â”‚
â”‚                                                              â”‚
â”‚ ä¾‹å­ï¼š                                                        â”‚
â”‚   å¥å­: [The, food, is, great, but, service, is, bad]       â”‚
â”‚   åŸå§‹mask:  [Â·, â–ˆ, Â·, Â·, Â·, Â·, Â·, Â·]                       â”‚
â”‚   æ“´å±•mask:  [â–ˆ, â–ˆ, â–ˆ, â–ˆ, â–ˆ, Â·, Â·, Â·]  (window=3)          â”‚
â”‚                                                              â”‚
â”‚ å„ªé»ï¼š                                                        â”‚
â”‚   âœ“ ç°¡å–®ç›´æ¥                                                 â”‚
â”‚   âœ“ æ•æ‰å±€éƒ¨opinionè©                                        â”‚
â”‚   âœ“ å¯èª¿ç¯€windowå¤§å°                                         â”‚
â”‚                                                              â”‚
â”‚ ç¼ºé»ï¼š                                                        â”‚
â”‚   âœ— å›ºå®šçª—å£ç„¡æ³•é©æ‡‰ä¸åŒå¥å­çµæ§‹                              â”‚
â”‚   âœ— å¯èƒ½å¼•å…¥å™ªè²è©                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆCï¼šDependency-Aware Maskingï¼ˆä¾è³´å¥æ³•æ„ŸçŸ¥ï¼‰â˜…â˜…â˜… æœ€ä½³      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ¸å¿ƒæ€æƒ³ï¼šä½¿ç”¨å¥æ³•ä¾è³´é—œä¿‚ç¢ºå®šç›¸é—œè©                          â”‚
â”‚                                                              â”‚
â”‚ å¯¦ç¾ï¼š                                                        â”‚
â”‚   1. ä½¿ç”¨ä¾è³´è§£æå™¨ï¼ˆå¦‚spaCyï¼‰                               â”‚
â”‚   2. æ‰¾å‡ºèˆ‡aspectæœ‰ç›´æ¥/é–“æ¥ä¾è³´é—œä¿‚çš„è©                     â”‚
â”‚   3. æ ¹æ“šä¾è³´è·é›¢è¨­ç½®maskæ¬Šé‡                                â”‚
â”‚                                                              â”‚
â”‚ ä¾‹å­ï¼š                                                        â”‚
â”‚   å¥å­: "The food is great"                                  â”‚
â”‚   ä¾è³´: food --nsubj--> is --acomp--> great                 â”‚
â”‚                                                              â”‚
â”‚   Maskæ¬Šé‡:                                                  â”‚
â”‚     food:  1.0  (aspectæœ¬èº«)                                â”‚
â”‚     is:    0.5  (ç›´æ¥ä¾è³´)                                  â”‚
â”‚     great: 0.8  (opinionè©ï¼Œé«˜æ¬Šé‡)                         â”‚
â”‚     The:   0.1  (é–“æ¥ä¾è³´ï¼Œä½æ¬Šé‡)                          â”‚
â”‚                                                              â”‚
â”‚ å„ªé»ï¼š                                                        â”‚
â”‚   âœ“âœ“âœ“ èªè¨€å­¸åˆç†æ€§æœ€å¼·                                       â”‚
â”‚   âœ“âœ“âœ“ è‡ªå‹•è­˜åˆ¥opinionè©                                      â”‚
â”‚   âœ“âœ“ é©æ‡‰ä¸åŒå¥å­çµæ§‹                                        â”‚
â”‚   âœ“ å¯è™•ç†é•·è·é›¢ä¾è³´                                         â”‚
â”‚                                                              â”‚
â”‚ ç¼ºé»ï¼š                                                        â”‚
â”‚   âœ— éœ€è¦é¡å¤–çš„ä¾è³´è§£æï¼ˆè¨ˆç®—æˆæœ¬ï¼‰                           â”‚
â”‚   âœ— ä¾è³´è§£æå™¨å¯èƒ½æœ‰éŒ¯èª¤                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ¡ˆDï¼šLearnable Maskï¼ˆå¯å­¸ç¿’é®ç½©ï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ¸å¿ƒæ€æƒ³ï¼šè®“æ¨¡å‹è‡ªå·±å­¸ç¿’å¦‚ä½•åˆ©ç”¨context                       â”‚
â”‚                                                              â”‚
â”‚ å¯¦ç¾ï¼š                                                        â”‚
â”‚   mask_logits = MaskNetwork(h_i, aspect_representation)      â”‚
â”‚   soft_mask = sigmoid(mask_logits)                          â”‚
â”‚   adjusted_score = original_score * soft_mask               â”‚
â”‚                                                              â”‚
â”‚ æ¶æ§‹ï¼š                                                        â”‚
â”‚   MaskNetwork = 2-layer MLP                                  â”‚
â”‚   è¼¸å…¥: [h_i; aspect_repr; distance_feature]                â”‚
â”‚   è¼¸å‡º: maskæ¬Šé‡ âˆˆ [0, 1]                                    â”‚
â”‚                                                              â”‚
â”‚ å„ªé»ï¼š                                                        â”‚
â”‚   âœ“âœ“ å®Œå…¨æ•¸æ“šé©…å‹•                                            â”‚
â”‚   âœ“âœ“ é©æ‡‰æ€§æœ€å¼·                                              â”‚
â”‚   âœ“ å¯å­¸ç¿’è¤‡é›œæ¨¡å¼                                           â”‚
â”‚                                                              â”‚
â”‚ ç¼ºé»ï¼š                                                        â”‚
â”‚   âœ— å¢åŠ åƒæ•¸é‡                                               â”‚
â”‚   âœ— éœ€è¦æ›´å¤šè¨“ç·´æ•¸æ“š                                         â”‚
â”‚   âœ— å¯è§£é‡‹æ€§é™ä½                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")


# ============================================================================
# ç¬¬å››éƒ¨åˆ†ï¼šå¯¦é©—ä»£ç¢¼ç¤ºç¯„
# ============================================================================

print_section("4. ä»£ç¢¼ç¤ºç¯„ï¼šç•¶å‰ vs è»Ÿé®ç½©")

print("\nã€æ¨¡æ“¬å¯¦é©—è¨­ç½®ã€‘")
batch_size = 2
seq_len = 8
hidden_size = 128

# æ¨¡æ“¬LSTMè¼¸å‡º
lstm_outputs = torch.randn(batch_size, seq_len, hidden_size * 2)

# æ¨¡æ“¬aspect mask
# æ¨£æœ¬1: aspectåœ¨ä½ç½®2 ("food")
# æ¨£æœ¬2: aspectåœ¨ä½ç½®5-6 ("battery life")
aspect_mask = torch.tensor([
    [False, False, True, False, False, False, False, False],  # "food"
    [False, False, False, False, False, True, True, False],   # "battery life"
], dtype=torch.bool)

print(f"\nLSTMè¼¸å‡ºå½¢ç‹€: {lstm_outputs.shape}")
print(f"Aspect Maskå½¢ç‹€: {aspect_mask.shape}")
print(f"\nAspect Mask:")
for i, mask in enumerate(aspect_mask):
    mask_str = ''.join(['â–ˆ' if m else 'Â·' for m in mask])
    print(f"  æ¨£æœ¬{i+1}: {mask_str}")


# ç•¶å‰ç¡¬é®ç½©æ–¹æ³•
print("\n" + "-"*80)
print("ã€æ–¹æ³•1ï¼šç•¶å‰ç¡¬é®ç½© (Hard Masking)ã€‘")
print("-"*80)

attention_layer = AttentionLayer(hidden_size=hidden_size)
context_hard, weights_hard = attention_layer(lstm_outputs, aspect_mask)

print("\nAttentionæ¬Šé‡åˆ†ä½ˆ:")
for i, weights in enumerate(weights_hard):
    print(f"  æ¨£æœ¬{i+1}: {[f'{w:.4f}' for w in weights.tolist()]}")
    aspect_sum = weights[aspect_mask[i]].sum().item()
    print(f"          Aspectè©æ¬Šé‡ç¸½å’Œ: {aspect_sum:.4f}")


# è»Ÿé®ç½©æ–¹æ³•ï¼ˆæ¨¡æ“¬ï¼‰
print("\n" + "-"*80)
print("ã€æ–¹æ³•2ï¼šè»Ÿé®ç½© (Soft Masking) - è·é›¢è¡°æ¸›ã€‘")
print("-"*80)

def soft_masking_attention(lstm_outputs, aspect_mask, penalty_weight=5.0):
    """
    è»Ÿé®ç½©ï¼šä½¿ç”¨è·é›¢è¡°æ¸›è€Œéç¡¬é®è”½

    Args:
        penalty_weight: æ‡²ç½°å¼·åº¦ï¼ˆè¶Šå¤§ï¼Œéaspectè©æ¬Šé‡è¶Šä½ï¼‰
    """
    batch_size, seq_len, hidden_dim = lstm_outputs.shape

    # è¨ˆç®—åŸå§‹attention scoresï¼ˆç°¡åŒ–ç‰ˆï¼‰
    scores = torch.randn(batch_size, seq_len)  # æ¨¡æ“¬attention scores

    # è¨ˆç®—æ¯å€‹tokenåˆ°æœ€è¿‘aspect tokençš„è·é›¢
    distances = torch.zeros(batch_size, seq_len)
    for b in range(batch_size):
        aspect_positions = torch.where(aspect_mask[b])[0]
        for t in range(seq_len):
            if aspect_mask[b, t]:
                distances[b, t] = 0  # aspectè©æœ¬èº«è·é›¢ç‚º0
            else:
                # åˆ°æœ€è¿‘aspectè©çš„è·é›¢
                dist = torch.abs(torch.tensor(t) - aspect_positions.float()).min()
                distances[b, t] = dist

    # æ‡‰ç”¨è·é›¢è¡°æ¸›æ‡²ç½°
    penalties = penalty_weight * distances
    adjusted_scores = scores - penalties

    # Softmax
    attention_weights = F.softmax(adjusted_scores, dim=1)

    return attention_weights, distances

weights_soft, distances = soft_masking_attention(lstm_outputs, aspect_mask, penalty_weight=5.0)

print("\nè·é›¢çŸ©é™£ï¼ˆåˆ°æœ€è¿‘aspectè©ï¼‰:")
for i, dist in enumerate(distances):
    print(f"  æ¨£æœ¬{i+1}: {[f'{d:.0f}' for d in dist.tolist()]}")

print("\nSoft Masking Attentionæ¬Šé‡åˆ†ä½ˆ:")
for i, weights in enumerate(weights_soft):
    print(f"  æ¨£æœ¬{i+1}: {[f'{w:.4f}' for w in weights.tolist()]}")
    aspect_sum = weights[aspect_mask[i]].sum().item()
    non_aspect_sum = weights[~aspect_mask[i]].sum().item()
    print(f"          Aspectè©æ¬Šé‡: {aspect_sum:.4f}")
    print(f"          éAspectè©æ¬Šé‡: {non_aspect_sum:.4f}")
    print(f"          é„°è¿‘è©(-1,+1)ç²å¾—æ¬Šé‡: {weights_soft[i][torch.abs(distances[i]) == 1].sum():.4f}")


# ä¸Šä¸‹æ–‡çª—å£æ–¹æ³•
print("\n" + "-"*80)
print("ã€æ–¹æ³•3ï¼šä¸Šä¸‹æ–‡çª—å£ (Context Window)ã€‘")
print("-"*80)

def context_window_masking(aspect_mask, window_size=2):
    """
    æ“´å±•maskåˆ°é„°è¿‘çª—å£

    Args:
        window_size: çª—å£å¤§å°ï¼ˆaspectå·¦å³å„å»¶ä¼¸å¤šå°‘å€‹tokenï¼‰
    """
    batch_size, seq_len = aspect_mask.shape
    extended_mask = aspect_mask.clone()

    for b in range(batch_size):
        aspect_positions = torch.where(aspect_mask[b])[0]
        for pos in aspect_positions:
            # æ“´å±•åˆ°å·¦å³é„°è¿‘token
            start = max(0, pos - window_size)
            end = min(seq_len, pos + window_size + 1)
            extended_mask[b, start:end] = True

    return extended_mask

extended_mask = context_window_masking(aspect_mask, window_size=2)

print("\næ“´å±•å¾Œçš„Mask (window_size=2):")
for i, (orig, ext) in enumerate(zip(aspect_mask, extended_mask)):
    orig_str = ''.join(['â–ˆ' if m else 'Â·' for m in orig])
    ext_str = ''.join(['â–ˆ' if m else 'Â·' for m in ext])
    print(f"  æ¨£æœ¬{i+1} åŸå§‹: {orig_str}")
    print(f"         æ“´å±•: {ext_str}")


# ============================================================================
# ç¬¬äº”éƒ¨åˆ†ï¼šæ¨è–¦æ–¹æ¡ˆå’Œå¯¦æ–½å»ºè­°
# ============================================================================

print_section("5. æ¨è–¦æ–¹æ¡ˆå’Œå¯¦æ–½å»ºè­°")

print("""
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨è–¦å¯¦æ–½å„ªå…ˆç´š                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ ğŸ¥‡ å„ªå…ˆç´š1ï¼šè»Ÿé®ç½© (Soft Masking) + è·é›¢è¡°æ¸›                 â”‚
â”‚    ç†ç”±ï¼š                                                     â”‚
â”‚      âœ“ å¯¦ç¾ç°¡å–®ï¼Œæ”¹å‹•æœ€å°                                     â”‚
â”‚      âœ“ ä¸éœ€è¦é¡å¤–æ•¸æ“šæˆ–æ¨¡å‹                                   â”‚
â”‚      âœ“ æ•ˆæœæ˜é¡¯ï¼ˆé æœŸ+3-5% F1ï¼‰                              â”‚
â”‚      âœ“ è¨ˆç®—é–‹éŠ·æ¥µå°                                           â”‚
â”‚                                                              â”‚
â”‚    å¯¦æ–½æ­¥é©Ÿï¼š                                                 â”‚
â”‚      1. ä¿®æ”¹ components.py çš„ AttentionLayer.forward()       â”‚
â”‚      2. å°‡ masked_fill(-1e9) æ”¹ç‚ºè·é›¢è¡°æ¸›æ‡²ç½°                â”‚
â”‚      3. æ·»åŠ è¶…åƒæ•¸ penalty_weight (å»ºè­°ç¯„åœ: 3-7)            â”‚
â”‚      4. åœ¨é©—è­‰é›†ä¸Šèª¿å„ª penalty_weight                         â”‚
â”‚                                                              â”‚
â”‚    ä»£ç¢¼ä¿®æ”¹é‡ï¼šç´„30è¡Œ                                         â”‚
â”‚    é ä¼°é–‹ç™¼æ™‚é–“ï¼š2-3å°æ™‚                                      â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ ğŸ¥ˆ å„ªå…ˆç´š2ï¼šä¸Šä¸‹æ–‡çª—å£ (Context Window)                       â”‚
â”‚    ç†ç”±ï¼š                                                     â”‚
â”‚      âœ“ å¯¦ç¾ä¹Ÿå¾ˆç°¡å–®                                           â”‚
â”‚      âœ“ å¯è§£é‡‹æ€§å¼·                                             â”‚
â”‚      âœ“ é©åˆçŸ­å¥å­                                             â”‚
â”‚                                                              â”‚
â”‚    å¯¦æ–½æ­¥é©Ÿï¼š                                                 â”‚
â”‚      1. åœ¨æ•¸æ“šåŠ è¼‰æ™‚æ“´å±•aspect_mask                           â”‚
â”‚      2. æ·»åŠ  window_size åƒæ•¸åˆ°é…ç½®                          â”‚
â”‚      3. ä¿æŒattentionæ©Ÿåˆ¶ä¸è®Š                                â”‚
â”‚                                                              â”‚
â”‚    ä»£ç¢¼ä¿®æ”¹é‡ï¼šç´„20è¡Œ                                         â”‚
â”‚    é ä¼°é–‹ç™¼æ™‚é–“ï¼š1-2å°æ™‚                                      â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ ğŸ¥‰ å„ªå…ˆç´š3ï¼šä¾è³´å¥æ³•æ„ŸçŸ¥ (Dependency-Aware)                  â”‚
â”‚    ç†ç”±ï¼š                                                     â”‚
â”‚      âœ“âœ“ ç†è«–ä¸Šæ•ˆæœæœ€å¥½                                        â”‚
â”‚      âœ“ èªè¨€å­¸åˆç†æ€§å¼·                                         â”‚
â”‚      âœ— éœ€è¦æ•´åˆspaCy                                          â”‚
â”‚      âœ— è¨ˆç®—é–‹éŠ·è¼ƒå¤§                                           â”‚
â”‚                                                              â”‚
â”‚    å¯¦æ–½æ­¥é©Ÿï¼š                                                 â”‚
â”‚      1. å®‰è£spaCy + è‹±æ–‡æ¨¡å‹                                 â”‚
â”‚      2. é è™•ç†éšæ®µè¨ˆç®—ä¾è³´é—œä¿‚                                â”‚
â”‚      3. å°‡ä¾è³´è·é›¢å­˜å…¥CSV                                     â”‚
â”‚      4. è¨“ç·´æ™‚ä½¿ç”¨ä¾è³´æ¬Šé‡                                    â”‚
â”‚                                                              â”‚
â”‚    ä»£ç¢¼ä¿®æ”¹é‡ï¼šç´„100è¡Œ                                        â”‚
â”‚    é ä¼°é–‹ç™¼æ™‚é–“ï¼š1-2å¤©                                        â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ ğŸ”¬ ç ”ç©¶æ–¹å‘ï¼šå¯å­¸ç¿’é®ç½© (Learnable Mask)                      â”‚
â”‚    ç†ç”±ï¼š                                                     â”‚
â”‚      âœ“âœ“ æ½›åŠ›æœ€å¤§                                              â”‚
â”‚      âœ—âœ— å¯¦ç¾è¤‡é›œ                                              â”‚
â”‚      âœ— éœ€è¦æ¶ˆèå¯¦é©—                                           â”‚
â”‚                                                              â”‚
â”‚    å»ºè­°ï¼šä½œç‚ºå¾ŒçºŒæ”¹é€²æ–¹å‘                                     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çµ„åˆç­–ç•¥å»ºè­°                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚ æœ€ä½³çµ„åˆï¼šè»Ÿé®ç½© + ä¸Šä¸‹æ–‡çª—å£                                â”‚
â”‚                                                              â”‚
â”‚   å¯¦æ–½æ–¹å¼ï¼š                                                  â”‚
â”‚     1. å…ˆæ“´å±•maskåˆ°window (å¦‚window=2)                       â”‚
â”‚     2. åœ¨windowå…§ä½¿ç”¨è»Ÿé®ç½©ï¼ˆè·é›¢è¡°æ¸›ï¼‰                       â”‚
â”‚     3. windowå¤–ç¡¬é®è”½                                         â”‚
â”‚                                                              â”‚
â”‚   å„ªé»ï¼š                                                      â”‚
â”‚     âœ“ å…¼é¡§æ•ˆç‡å’Œæ•ˆæœ                                          â”‚
â”‚     âœ“ æ§åˆ¶ä¿¡æ¯é‡ï¼ˆé¿å…éå¤šå™ªè²ï¼‰                              â”‚
â”‚     âœ“ å…©å€‹è¶…åƒæ•¸å¯èª¿                                          â”‚
â”‚                                                              â”‚
â”‚   é æœŸæ•ˆæœæå‡ï¼š                                              â”‚
â”‚     - Restaurant: F1 67% â†’ 72% (+5%)                        â”‚
â”‚     - Laptop: F1 41% â†’ 47% (+6%)                            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
""")


print_section("6. å¿«é€Ÿå¯¦æ–½ä»£ç¢¼ç¤ºä¾‹")

print("""
ä¿®æ”¹ src/models/components.py çš„ AttentionLayer:

```python
class AttentionLayer(nn.Module):
    def __init__(self, hidden_size, attention_size=None, use_soft_mask=True,
                 penalty_weight=5.0, window_size=2):
        super().__init__()
        self.hidden_size = hidden_size * 2
        self.use_soft_mask = use_soft_mask
        self.penalty_weight = penalty_weight
        self.window_size = window_size

        self.W = nn.Linear(self.hidden_size, attention_size or hidden_size, bias=True)
        self.v = nn.Linear(attention_size or hidden_size, 1, bias=False)
        self._init_weights()

    def forward(self, lstm_outputs, aspect_mask):
        # è¨ˆç®—attention scores
        attention_scores = self.v(torch.tanh(self.W(lstm_outputs)))
        attention_scores = attention_scores.squeeze(-1)

        if self.use_soft_mask:
            # è»Ÿé®ç½©ï¼šè¨ˆç®—è·é›¢æ‡²ç½°
            batch_size, seq_len = aspect_mask.shape
            distances = self._compute_distances(aspect_mask, seq_len)
            penalties = self.penalty_weight * distances
            attention_scores = attention_scores - penalties
        else:
            # ç¡¬é®ç½©ï¼šåŸå§‹æ–¹æ³•
            attention_scores = attention_scores.masked_fill(~aspect_mask, -1e9)

        attention_weights = F.softmax(attention_scores, dim=1)

        # æ•¸å€¼ç©©å®šæ€§æª¢æŸ¥
        if torch.isnan(attention_weights).any():
            attention_weights = aspect_mask.float() / aspect_mask.sum(dim=1, keepdim=True).clamp(min=1)

        # åŠ æ¬Šæ±‚å’Œ
        attention_output = torch.bmm(
            attention_weights.unsqueeze(1),
            lstm_outputs
        ).squeeze(1)

        return attention_output, attention_weights

    def _compute_distances(self, aspect_mask, seq_len):
        \"\"\"è¨ˆç®—æ¯å€‹tokenåˆ°æœ€è¿‘aspect tokençš„è·é›¢\"\"\"
        batch_size = aspect_mask.size(0)
        distances = torch.zeros_like(aspect_mask, dtype=torch.float)

        for b in range(batch_size):
            aspect_positions = torch.where(aspect_mask[b])[0]
            if len(aspect_positions) == 0:
                continue

            for t in range(seq_len):
                if aspect_mask[b, t]:
                    distances[b, t] = 0
                else:
                    # æ“´å±•çª—å£å…§ä½¿ç”¨æ¼¸è®Šè·é›¢ï¼Œå¤–éƒ¨ä½¿ç”¨å¤§æ‡²ç½°
                    dist = torch.abs(torch.tensor(t, dtype=torch.float) - aspect_positions.float()).min()
                    if dist <= self.window_size:
                        distances[b, t] = dist  # çª—å£å…§ï¼šç·šæ€§è·é›¢
                    else:
                        distances[b, t] = dist * 2  # çª—å£å¤–ï¼šé›™å€æ‡²ç½°

        return distances
```

åœ¨ experiment_config.py ä¸­æ·»åŠ é…ç½®:

```python
BASELINE_CONFIG = {
    ...
    "use_soft_mask": True,       # ä½¿ç”¨è»Ÿé®ç½©
    "penalty_weight": 5.0,       # æ‡²ç½°å¼·åº¦
    "context_window": 2,         # ä¸Šä¸‹æ–‡çª—å£å¤§å°
}
```
""")

print("\n" + "="*80)
print("åˆ†æå®Œæˆï¼å»ºè­°å…ˆå¯¦æ–½ã€å„ªå…ˆç´š1ï¼šè»Ÿé®ç½©ã€‘ï¼Œé æœŸå¯æå‡5-6% F1åˆ†æ•¸")
print("="*80 + "\n")
